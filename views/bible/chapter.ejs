<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ç¬¬ <%= chapter %> ç«  - æ€é«˜åœ£ç»</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“œ ç¬¬ <%= chapter %> ç« </h1>
        <ul class="verse-list">
            <% verses.forEach(function(v){ %>
                <li>
                    <% if (v.verse_ref) { %>
                        <span class="verse-ref"><%= v.verse_ref %></span>
                    <% } %>
                    <span class="verse-text"><%= v.text %></span>
                </li>
            <% }) %>
        </ul>
        
        <!-- AI è¾…åŠ©åŠŸèƒ½ -->
        <div class="ai-features">
            <h2>ğŸ¤– AI è¯»ç»è¾…åŠ©</h2>
            <div class="ai-buttons">
                <button class="ai-btn" data-function="summary">ğŸ“‹ ç»æ–‡æ€»ç»“</button>
                <button class="ai-btn" data-function="history">ğŸ“œ å†å²èƒŒæ™¯</button>
                <button class="ai-btn" data-function="saints">ğŸ‘¼ åœ£äººè¯ é‡Š</button>
                <button class="ai-btn" data-function="prayer">ğŸ™ ç¥ˆç¥·æŒ‡å¼•</button>
            </div>
            <div id="ai-result" class="ai-result" style="display: none;">
                <div class="ai-result-header">
                    <h3 id="ai-result-title"></h3>
                    <button id="ai-result-close" class="ai-close-btn">âœ•</button>
                </div>
                <div id="ai-result-content" class="ai-result-content"></div>
                <div id="ai-result-loading" class="ai-loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨ç”Ÿæˆå†…å®¹...</p>
                </div>
                <div id="ai-result-error" class="ai-error" style="display: none;"></div>
            </div>
        </div>
        
        <div class="nav-links">
            <a href="/book/<%= bookId %>">â† è¿”å›ç« èŠ‚åˆ—è¡¨</a>
            <a href="/">ğŸ  è¿”å›é¦–é¡µ</a>
        </div>
    </div>
    <script src="/js/main.js"></script>
    <script src="/js/reading-progress.js"></script>
    <script>
        // AI åŠŸèƒ½è„šæœ¬
        (function() {
            var aiButtons = document.querySelectorAll('.ai-btn');
            var resultBox = document.getElementById('ai-result');
            var resultTitle = document.getElementById('ai-result-title');
            var resultContent = document.getElementById('ai-result-content');
            var resultLoading = document.getElementById('ai-result-loading');
            var resultError = document.getElementById('ai-result-error');
            var closeBtn = document.getElementById('ai-result-close');
            
            var functionNames = {
                'summary': 'ğŸ“‹ ç»æ–‡æ€»ç»“',
                'history': 'ğŸ“œ å†å²èƒŒæ™¯',
                'saints': 'ğŸ‘¼ åœ£äººè¯ é‡Š',
                'prayer': 'ğŸ™ ç¥ˆç¥·æŒ‡å¼•'
            };
            
            // å…³é—­ç»“æœæ¡†
            closeBtn.addEventListener('click', function() {
                resultBox.style.display = 'none';
            });
            
            // ä¸ºæ¯ä¸ªæŒ‰é’®ç»‘å®šç‚¹å‡»äº‹ä»¶
            for (var i = 0; i < aiButtons.length; i++) {
                aiButtons[i].addEventListener('click', function() {
                    var functionType = this.getAttribute('data-function');
                    requestAI(functionType);
                });
            }
            
            function requestAI(functionType) {
                // æ˜¾ç¤ºç»“æœæ¡†å’ŒåŠ è½½çŠ¶æ€
                resultBox.style.display = 'block';
                resultTitle.textContent = functionNames[functionType];
                resultContent.style.display = 'none';
                resultError.style.display = 'none';
                resultLoading.style.display = 'block';
                
                // æ»šåŠ¨åˆ°ç»“æœæ¡†
                resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // å‘é€è¯·æ±‚
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/api/ai/generate', true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        resultLoading.style.display = 'none';
                        
                        if (xhr.status === 200) {
                            try {
                                var data = JSON.parse(xhr.responseText);
                                if (data.success && data.data && data.data.content) {
                                    resultContent.innerHTML = formatAIResponse(data.data.content);
                                    resultContent.style.display = 'block';
                                } else {
                                    showError(data.message || 'ç”Ÿæˆå¤±è´¥');
                                }
                            } catch (e) {
                                showError('è§£æå“åº”å¤±è´¥ï¼š' + e.message);
                            }
                        } else {
                            var errorMsg = 'è¯·æ±‚å¤±è´¥ï¼ˆ' + xhr.status + 'ï¼‰';
                            try {
                                var errorData = JSON.parse(xhr.responseText);
                                errorMsg = errorData.message || errorMsg;
                            } catch (e) {}
                            showError(errorMsg);
                        }
                    }
                };
                
                xhr.onerror = function() {
                    resultLoading.style.display = 'none';
                    showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
                };
                
                // è·å–å½“å‰ç« èŠ‚ä¿¡æ¯
                var bookId = '<%= bookId %>';
                var chapter = '<%= chapter %>';
                
                xhr.send(JSON.stringify({
                    function_type: functionType,
                    book_id: bookId,
                    chapter: chapter,
                    lang: 'zh'
                }));
            }
            
            function showError(message) {
                resultError.textContent = 'âŒ ' + message;
                resultError.style.display = 'block';
            }
            
            function formatAIResponse(content) {
                // å°†æ¢è¡Œè½¬ä¸º <br>ï¼Œä¿ç•™æ®µè½æ ¼å¼
                var formatted = content
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>');
                return '<p>' + formatted + '</p>';
            }
        })();
    </script>
</body>
</html>
