<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Magisterium PoC (stream)</title>
    <style>
      body { font-family: system-ui, Arial; padding: 20px; }
      textarea { width: 100%; height: 100px; }
      pre { background:#111; color:#e6e6e6; padding:10px; height:300px; overflow:auto; }
      button { padding:8px 12px; }
    </style>
  </head>
  <body>
    <h2>Magisterium PoC — streaming</h2>
    <p>在下面输入用户消息，点击 <strong>Send</strong>。注意：API key 需在服务器端通过环境变量 <code>MAGISTERIUM_API_KEY</code> 设置。</p>

    <label>Message</label>
    <textarea id="prompt">What is the Magisterium?</textarea>
    <div style="margin-top:8px">
      <button id="send">Send (stream)</button>
    </div>

    <h3>Streaming output</h3>
    <pre id="out"></pre>

    <script>
      const out = document.getElementById('out');
      document.getElementById('send').addEventListener('click', async () => {
        out.textContent = '';
        const message = document.getElementById('prompt').value;

        const resp = await fetch('/api/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: 'magisterium-1', messages: [{ role: 'user', content: message }] })
        });

        if (!resp.ok) {
          const text = await resp.text();
          out.textContent = `Error: ${resp.status}\n${text}`;
          return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let done = false;
        while (!done) {
          const { value, done: d } = await reader.read();
          done = d;
          if (value) {
            out.textContent += decoder.decode(value, { stream: true });
            out.scrollTop = out.scrollHeight;
          }
        }
      });
    </script>
  </body>
</html>
